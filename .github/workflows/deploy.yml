name: Deploy
on:
  workflow_run:
    workflows: ["Build"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Install Helm
        run: |
          curl -fsSL -o helm.tar.gz https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz
          tar -xzf helm.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          
      - name: Deploy to Minikube
        run: |
          helm upgrade --install slab-ai helm/slab-ai -n slab-ai \
            --set image.repository=slab-backend \
            --set image.tag=prod

      - name: Verify Deployment
        run: |
          kubectl rollout status deployment/slab-ai -n slab-ai --timeout=60s || \
          (helm rollback slab-ai 0 && exit 1)
